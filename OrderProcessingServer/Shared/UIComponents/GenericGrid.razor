@typeparam TItem
@using System.Linq.Expressions
@using OrderProcessingServer.Shared.UIComponents
@using OrderProcessingSystem.Utilities.Extensions
@inject IJSRuntime JS

<div class="card p-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="d-flex align-items-center">
            <button class="btn btn-outline-secondary me-2" @onclick="ExportAll" disabled="@(Items==null || !Items.Any())">Export All</button>
            <button class="btn btn-outline-secondary me-3" @onclick="ExportFiltered" disabled="@(Items==null || !IsFilterActive())">Export Filtered</button>
            <button class="btn btn-outline-secondary me-3" @onclick="ClearAllFilters" disabled="@(!IsFilterActive())">Clear Filters</button>

            <label class="me-2">Page size:</label>
            <select class="form-select d-inline-block w-auto" @onchange="OnPageSizeChanged">
                @foreach (var s in PageSizes)
                {
                    <option selected="@(s==PageSize)" value="@s">@s</option>
                }
            </select>
        </div>
        <div>
            <small>Showing @((PagedItems?.Count ?? 0)) of @(FilteredTotalCount) items</small>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    @foreach(var c in Columns)
                    {
                                <th style="position:relative;" class="@(IsNumericColumn(c) ? "text-end" : string.Empty)">
                                    <div class="d-flex align-items-center @(IsNumericColumn(c) ? "justify-content-end" : "")">
                                        <span class="@(IsNumericColumn(c) ? "me-2 text-end" : "")">@c.Header</span>
                                        @if (c.Filterable)
                                        {
                                            <button id="@($"{_gridId}-btn-{c.Field}")" class="btn btn-sm btn-light ms-2" @onclick="() => ToggleFilter(c)">ðŸ”½</button>
                                            @if (ColumnFilters.TryGetValue(c.Field, out var _fs) && (!string.IsNullOrWhiteSpace(_fs.TextValue) || !string.IsNullOrWhiteSpace(_fs.EnumValue)))
                                            {
                                                <span class="filter-indicator ms-1" title="Filter active"></span>
                                            }
                                        }
                                        @if (c.Sortable)
                                        {
                                            <button class="btn btn-sm btn-light ms-1" @onclick="() => ToggleSort(c)">â†•</button>
                                        }
                                    </div>
                                    @if (ActiveFilterColumn == c)
                                    {
                                        <div id="@($"{_gridId}-popup-{c.Field}")" class="grid-filter-popup p-2 shadow-sm bg-white border @(ShouldFlipFilterPopup ? "flip-up" : "")" style="display:block;">
                                            @if (c.IsEnum && c.EnumValues != null)
                                            {
                                                <select class="form-select form-select-sm" @bind="EnumFilterValue">
                                                    <option value="">Any</option>
                                                    @foreach(var v in c.EnumValues) { <option value="@v">@v</option> }
                                                </select>
                                            }
                                            else
                                            {
                                                <select class="form-select form-select-sm mb-1" @bind="TextFilterOp">
                                                    @foreach(var op in TextOps) { <option value="@op">@op</option> }
                                                </select>
                                                <input class="form-control form-control-sm" @bind="TextFilterValue" />
                                            }
                                            <div class="mt-2 text-end">
                                                <button class="btn btn-sm btn-primary me-1" @onclick="ApplyFilter">Apply</button>
                                                <button class="btn btn-sm btn-link" @onclick="ClearFilter">Clear</button>
                                            </div>
                                        </div>
                                    }
                                </th>
                    }
                </tr>
            </thead>
            <tbody>
                @if (PagedItems != null)
                {
                    @foreach(var item in PagedItems)
                    {
                        <tr>
                            @foreach(var c in Columns)
                            {
                                var raw = GetValue(item, c.Field);
                                string outVal;
                                string cellClass = string.Empty;
                                if (raw != null)
                                {
                                    var t = raw.GetType();
                                    var tc = System.Type.GetTypeCode(t);
                                    if (tc == TypeCode.Decimal || tc == TypeCode.Double || tc == TypeCode.Single)
                                    {
                                        // floating-point / decimal-capable values: format to two decimals and right-align
                                        cellClass = "text-end";
                                        try
                                        {
                                            var d = Convert.ToDouble(raw);
                                            outVal = d.ToTwoDecimals(false);
                                        }
                                        catch { outVal = raw.ToString() ?? string.Empty; }
                                    }
                                    else if (tc == TypeCode.Int16 || tc == TypeCode.Int32 || tc == TypeCode.Int64 ||
                                             tc == TypeCode.UInt16 || tc == TypeCode.UInt32 || tc == TypeCode.UInt64 ||
                                             tc == TypeCode.Byte || tc == TypeCode.SByte)
                                    {
                                        // integer types: no decimal places, right-align
                                        cellClass = "text-end";
                                        try
                                        {
                                            outVal = raw.ToString() ?? string.Empty;
                                        }
                                        catch { outVal = raw.ToString() ?? string.Empty; }
                                    }
                                    else
                                    {
                                        outVal = raw.ToString() ?? string.Empty;
                                    }
                                }
                                else outVal = string.Empty;
                                <td class="@cellClass">@(outVal)</td>
                            }
                        </tr>
                    }
                    // Ensure the table body keeps a minimum height by rendering empty placeholder rows.
                    // If there are no displayed items, render exactly 1 placeholder row; otherwise keep the
                    // existing behavior (minRows = 5) so the grid doesn't collapse.
                    var displayed = PagedItems.Count;
                    var minRows = (displayed == 0) ? 1 : 5;
                    if (displayed < minRows)
                    {
                        for (int r = displayed; r < minRows; r++)
                        {
                            <tr class="table-placeholder-row">
                                @foreach (var c in Columns)
                                {
                                    <td>&nbsp;</td>
                                }
                            </tr>
                        }
                    }
                }
            </tbody>
        </table>
    </div>

    <nav aria-label="grid-paging">
        <ul class="pagination justify-content-center align-items-center">
            <li class="page-item @(CurrentPage==1?"disabled":"")"><button class="page-link" @onclick="() => GoToPage(1)">Â«</button></li>
            <li class="page-item @(CurrentPage==1?"disabled":"")"><button class="page-link" @onclick="() => GoToPage(CurrentPage-1)">Previous</button></li>

            <li class="page-item px-2">
                <select class="form-select form-select-sm" style="width:100px; display:inline-block" @onchange="OnPageSelect" value="@CurrentPage">
                    @for (int p = 1; p <= TotalPages; p++)
                    {
                        <option value="@p" selected="@(p==CurrentPage)">Page @p</option>
                    }
                </select>
            </li>

            <li class="page-item @(CurrentPage==TotalPages?"disabled":"")"><button class="page-link" @onclick="() => GoToPage(CurrentPage+1)">Next</button></li>
            <li class="page-item @(CurrentPage==TotalPages?"disabled":"")"><button class="page-link" @onclick="() => GoToPage(TotalPages)">Â»</button></li>
        </ul>
    </nav>
</div>

@code {
    [Parameter] public IEnumerable<TItem>? Items { get; set; }
    [Parameter] public List<GridColumn> Columns { get; set; } = new List<GridColumn>();
    [Parameter] public int PageSize { get; set; } = 10;
    [Parameter] public int[] PageSizes { get; set; } = new[] {5,10,15};

    List<TItem>? PagedItems;
    int CurrentPage = 1;
    int TotalPages = 1;
    int FilteredTotalCount = 0;

    // filtering state
    GridColumn? ActiveFilterColumn;
    string[] TextOps = new[] {"StartsWith","EndsWith","Equals"};
    // temporary inputs for the currently-open filter popup
    string TextFilterOp = "StartsWith";
    string TextFilterValue = string.Empty;
    string EnumFilterValue = string.Empty;

    // persistent per-column filters (field -> FilterState)
    class FilterState {
        public string TextOp { get; set; } = "StartsWith";
        public string TextValue { get; set; } = string.Empty;
        public string EnumValue { get; set; } = string.Empty;
        public bool IsEnum { get; set; } = false;
    }
    Dictionary<string, FilterState> ColumnFilters = new Dictionary<string, FilterState>();

    // sorting
    GridColumn? SortColumn;
    bool SortAsc = true;

    protected override void OnParametersSet()
    {
        PageSize = PageSize;
        SetupPaging();
    }

    void SetupPaging()
    {
        CurrentPage = 1;
        var c = (Items?.Count() ?? 0);
        TotalPages = Math.Max(1, (int)Math.Ceiling((double)c / PageSize));
        ApplyPage();
    }

    void ApplyPage()
    {
        if (Items == null) { PagedItems = new List<TItem>(); return; }
    var list = ApplyFilterList(Items.ToList());
    FilteredTotalCount = list.Count;
        if (SortColumn != null) list = ApplySort(list, SortColumn, SortAsc);
        TotalPages = Math.Max(1, (int)Math.Ceiling((double)list.Count / PageSize));
        if (CurrentPage < 1) CurrentPage = 1;
        if (CurrentPage > TotalPages) CurrentPage = TotalPages;
        PagedItems = list.Skip((CurrentPage - 1) * PageSize).Take(PageSize).ToList();
    }

    List<TItem> ApplyFilterList(List<TItem> input)
    {
        if (input == null) return new List<TItem>();
        IEnumerable<TItem> q = input;
        // Apply all column filters present in ColumnFilters (persisted per-column state)
        foreach (var kv in ColumnFilters)
        {
            var field = kv.Key;
            var fs = kv.Value;
            if (fs.IsEnum)
            {
                if (!string.IsNullOrWhiteSpace(fs.EnumValue))
                {
                    q = q.Where(i => string.Equals(GetValue(i, field)?.ToString() ?? string.Empty, fs.EnumValue, StringComparison.OrdinalIgnoreCase));
                }
            }
            else
            {
                if (!string.IsNullOrWhiteSpace(fs.TextValue))
                {
                    var t = fs.TextValue.Trim();
                    q = q.Where(i => MatchText(GetValue(i, field)?.ToString() ?? string.Empty, t, fs.TextOp));
                }
            }
        }
        return q.ToList();
    }

    List<TItem> ApplySort(List<TItem> input, GridColumn col, bool asc)
    {
        var sampleItem = input.FirstOrDefault(i => GetValue(i, col.Field) != null);
        var sampleVal = sampleItem != null ? GetValue(sampleItem, col.Field) : null;

        if (sampleVal != null)
        {
            var t = sampleVal.GetType();
            var typeCode = System.Type.GetTypeCode(t);

            bool isNumeric = typeCode == TypeCode.Byte || typeCode == TypeCode.SByte || typeCode == TypeCode.Int16 ||
                             typeCode == TypeCode.UInt16 || typeCode == TypeCode.Int32 || typeCode == TypeCode.UInt32 ||
                             typeCode == TypeCode.Int64 || typeCode == TypeCode.UInt64 || typeCode == TypeCode.Single ||
                             typeCode == TypeCode.Double || typeCode == TypeCode.Decimal;

            if (isNumeric)
            {
                if (asc)
                    return input.OrderBy(i => {
                        var v = GetValue(i, col.Field);
                        try { return Convert.ToDecimal(v ?? 0); } catch { return decimal.MinValue; }
                    }).ToList();
                else
                    return input.OrderByDescending(i => {
                        var v = GetValue(i, col.Field);
                        try { return Convert.ToDecimal(v ?? 0); } catch { return decimal.MinValue; }
                    }).ToList();
            }

            if (typeCode == TypeCode.DateTime)
            {
                if (asc)
                    return input.OrderBy(i => {
                        var v = GetValue(i, col.Field);
                        return v is DateTime dt ? dt : DateTime.MinValue;
                    }).ToList();
                else
                    return input.OrderByDescending(i => {
                        var v = GetValue(i, col.Field);
                        return v is DateTime dt ? dt : DateTime.MinValue;
                    }).ToList();
            }
        }

        return asc
            ? input.OrderBy(i => (GetValue(i, col.Field)?.ToString() ?? string.Empty)).ToList()
            : input.OrderByDescending(i => (GetValue(i, col.Field)?.ToString() ?? string.Empty)).ToList();
    }

    object? GetValue(TItem? item, string field)
    {
        if (item == null) return null;
        var parts = (field ?? string.Empty).Split('.', StringSplitOptions.RemoveEmptyEntries);
        object? cur = item as object;
        foreach (var p in parts)
        {
            if (cur == null) return null;
            var prop = cur.GetType().GetProperty(p);
            if (prop == null) return null;
            cur = prop.GetValue(cur);
        }
        return cur;
    }

    static bool MatchText(string value, string term, string op)
    {
        if (value == null) return false;
        return op switch
        {
            "StartsWith" => value.StartsWith(term, StringComparison.OrdinalIgnoreCase),
            "EndsWith" => value.EndsWith(term, StringComparison.OrdinalIgnoreCase),
            "Equals" => string.Equals(value, term, StringComparison.OrdinalIgnoreCase),
            _ => value.IndexOf(term, StringComparison.OrdinalIgnoreCase) >= 0
        };
    }

    bool IsNumericColumn(GridColumn c)
    {
        if (c == null) return false;
        // explicit override from column definition
        if (c.IsNumeric) return true;
        if (Items == null || string.IsNullOrWhiteSpace(c.Field)) return false;
        var sample = Items.FirstOrDefault(i => GetValue(i, c.Field) != null);
        if (sample == null) return false;
        var raw = GetValue(sample, c.Field);
        if (raw == null) return false;
        return raw.GetType().IsNumericType();
    }

    async Task ToggleFilter(GridColumn c)
    {
        var btnId = $"{_gridId}-btn-{c.Field}";
        var popupId = $"{_gridId}-popup-{c.Field}";

        // If this column is already active, hide popup first then clear active
        if (ActiveFilterColumn == c)
        {
            try { await JS.InvokeVoidAsync("hidePopup", popupId); } catch { }
            ActiveFilterColumn = null;
            await InvokeAsync(StateHasChanged);
            return;
        }

        // open popup for this column; load persisted filter values if present
        ActiveFilterColumn = c;
        if (ColumnFilters.TryGetValue(c.Field, out var fs))
        {
            TextFilterOp = fs.TextOp;
            TextFilterValue = fs.TextValue;
            EnumFilterValue = fs.EnumValue;
        }
        else
        {
            TextFilterOp = "StartsWith";
            TextFilterValue = string.Empty;
            EnumFilterValue = string.Empty;
        }

    // ensure DOM updates so popup element exists, then position it via JS
    await InvokeAsync(StateHasChanged);
    // small delay to let the browser layout stabilize (helps when table is empty)
    await Task.Delay(250);
    try { await JS.InvokeVoidAsync("showPopup", btnId, popupId); } catch { }
    }

    bool ShouldFlipFilterPopup => (PagedItems == null || !PagedItems.Any());

    // stable id per grid instance (used for element ids)
    string _gridId = "grid-" + System.Guid.NewGuid().ToString("N");

    async Task ApplyFilter()
    {
        // persist current inputs for the active column and re-run filtering
        if (ActiveFilterColumn != null)
        {
            ColumnFilters[ActiveFilterColumn.Field] = new FilterState {
                TextOp = TextFilterOp,
                TextValue = TextFilterValue,
                EnumValue = EnumFilterValue,
                IsEnum = ActiveFilterColumn.IsEnum
            };
        }
        CurrentPage = 1;
        ApplyPage();
        // close popup for the active column
        var col = ActiveFilterColumn;
        if (col != null)
        {
            try { await JS.InvokeVoidAsync("hidePopup", $"{_gridId}-popup-{col.Field}"); } catch { }
        }
        ActiveFilterColumn = null;
        await InvokeAsync(StateHasChanged);
    }

    void ClearFilter()
    {
        // clear only the active column's persisted filter
        if (ActiveFilterColumn != null)
        {
            ColumnFilters.Remove(ActiveFilterColumn.Field);
        }
        TextFilterValue = EnumFilterValue = string.Empty;
        TextFilterOp = "StartsWith";
        ActiveFilterColumn = null;
        ApplyPage();
    }

    void ToggleSort(GridColumn c)
    {
        if (SortColumn == c) SortAsc = !SortAsc;
        else { SortColumn = c; SortAsc = true; }
        ApplyPage();
    }

    void OnPageSizeChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e?.Value?.ToString(), out var s)) { PageSize = s; SetupPaging(); }
    }

    void GoToPage(int p)
    {
        CurrentPage = Math.Clamp(p, 1, TotalPages);
        ApplyPage();
    }

    void OnPageSelect(ChangeEventArgs e)
    {
        if (int.TryParse(e?.Value?.ToString(), out var p))
        {
            GoToPage(p);
        }
    }

    bool IsFilterActive()
    {
    return ColumnFilters.Any(kv => !string.IsNullOrWhiteSpace(kv.Value.TextValue) || !string.IsNullOrWhiteSpace(kv.Value.EnumValue));
    }

    async Task ExportAll()
    {
        if (Items == null) return;
        var csv = BuildCsv(Items.ToList());
        var filename = $"grid_all_{DateTime.UtcNow:yyyyMMddHHmmss}.csv";
        await JS.InvokeVoidAsync("blazorDownload", filename, csv);
    }

    async Task ExportFiltered()
    {
        if (Items == null) return;
        var list = ApplyFilterList(Items.ToList());
        var csv = BuildCsv(list);
        var filename = $"grid_filtered_{DateTime.UtcNow:yyyyMMddHHmmss}.csv";
        await JS.InvokeVoidAsync("blazorDownload", filename, csv);
    }

    string BuildCsv(List<TItem> list)
    {
        var sb = new System.Text.StringBuilder();
        sb.AppendLine(string.Join(',', Columns.Select(c => c.Header)));
        foreach (var it in list)
        {
            var row = Columns.Select(c => EscapeCsv((GetValue(it, c.Field)?.ToString() ?? string.Empty))).ToArray();
            sb.AppendLine(string.Join(',', row));
        }
        return sb.ToString();
    }

    static string EscapeCsv(string input)
    {
        if (input == null) return string.Empty;
        if (input.Contains(',') || input.Contains('"') || input.Contains('\n')) return '"' + input.Replace("\"", "\"\"") + '"';
        return input;
    }
}

@code {
    void ClearAllFilters()
    {
        ColumnFilters.Clear();
        ApplyPage();
    }
}

<link rel="stylesheet" href="~/css/generic-grid.css" />
