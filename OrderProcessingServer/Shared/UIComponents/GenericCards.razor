@typeparam TItem
@using System.Linq.Expressions
@using OrderProcessingServer.Shared.UIComponents
@using OrderProcessingSystem.Utilities.Extensions
@inject IJSRuntime JS

<div class="card p-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="d-flex align-items-center">
            <button class="btn btn-outline-secondary me-2" @onclick="ExportAll" disabled="@(Items==null || !Items.Any())">Export All</button>
            <button class="btn btn-outline-secondary me-3" @onclick="ExportFiltered" disabled="@(Items==null || !IsFilterActive())">Export Filtered</button>
            <button class="btn btn-outline-secondary me-3" @onclick="ClearAllFilters" disabled="@(!IsFilterActive())">Clear Filters</button>

            <label class="me-2">Page size:</label>
            <select class="form-select d-inline-block w-auto" @onchange="OnPageSizeChanged">
                @foreach (var s in PageSizes)
                {
                    <option selected="@(s==PageSize)" value="@s">@s</option>
                }
            </select>
        </div>
        <div>
            <small>Showing @((PagedItems?.Count ?? 0)) of @(FilteredTotalCount) cards</small>
        </div>
    </div>

    @* Filter Controls Row *@
    @if (Columns.Any(c => c.Filterable))
    {
        <div class="row mb-3">
            @foreach (var column in Columns.Where(c => c.Filterable))
            {
                <div class="col-12 col-md-6 col-lg-4 mb-2">
                    <div class="card border-light">
                        <div class="card-body p-2">
                            <label class="form-label small fw-bold">@column.Header</label>
                            @if (column.IsEnum && column.EnumValues != null)
                            {
                                <select class="form-select form-select-sm" @onchange="@(e => OnEnumFilterChanged(column.Field, e))">
                                    <option value="">All @column.Header</option>
                                    @foreach (var enumVal in column.EnumValues)
                                    {
                                        var isSelected = ColumnFilters.TryGetValue(column.Field, out var fs) && fs.EnumValue == enumVal;
                                        <option selected="@isSelected" value="@enumVal">@enumVal</option>
                                    }
                                </select>
                            }
                            else
                            {
                                <div class="input-group input-group-sm">
                                    <select class="form-select" style="max-width: 130px; flex-shrink: 0;" @onchange="@(e => OnTextFilterOpChanged(column.Field, e))">
                                        @foreach (var op in TextOps)
                                        {
                                            var isSelected = ColumnFilters.TryGetValue(column.Field, out var fs2) && fs2.TextOp == op;
                                            <option selected="@isSelected" value="@op">@op</option>
                                        }
                                    </select>
                                    <input type="text" class="form-control" style="flex: 1; min-width: 120px;" placeholder="Filter @column.Header..."
                                           value="@(ColumnFilters.TryGetValue(column.Field, out var fs3) ? fs3.TextValue : "")"
                                           @onchange="@(e => OnTextFilterChanged(column.Field, e))" />
                                </div>
                            }
                            @if (ColumnFilters.TryGetValue(column.Field, out var fs4) && (!string.IsNullOrWhiteSpace(fs4.TextValue) || !string.IsNullOrWhiteSpace(fs4.EnumValue)))
                            {
                                <button class="btn btn-sm btn-outline-danger mt-1" @onclick="() => ClearColumnFilter(column.Field)">Clear</button>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }

    @* Sort Controls *@
    @if (Columns.Any(c => c.Sortable))
    {
        <div class="mb-3">
            <label class="me-2 fw-bold">Sort by:</label>
            <select class="form-select d-inline-block w-auto me-2" @onchange="OnSortColumnChanged">
                <option value="">No sorting</option>
                @foreach (var col in Columns.Where(c => c.Sortable))
                {
                    <option selected="@(SortColumn?.Field == col.Field)" value="@col.Field">@col.Header</option>
                }
            </select>
            @if (SortColumn != null)
            {
                <button class="btn btn-sm btn-outline-secondary" @onclick="ToggleSortDirection">
                    @(SortAsc ? "↑ Ascending" : "↓ Descending")
                </button>
            }
        </div>
    }

    @* Cards Display *@
    <div class="row g-3">
        @if (PagedItems != null && PagedItems.Any())
        {
            @foreach (var item in PagedItems)
            {
                <div class="@CardColumnClass">
                    @CardTemplate!(item)
                </div>
            }
        }
        else if (Items != null && Items.Any())
        {
            <div class="col-12">
                <div class="alert alert-info">No items match the current filters.</div>
            </div>
        }
        else
        {
            <div class="col-12">
                <div class="alert alert-secondary">No data available.</div>
            </div>
        }
    </div>

    @* Pagination *@
    <nav aria-label="card-paging" class="mt-3">
        <ul class="pagination justify-content-center align-items-center">
            <li class="page-item @(CurrentPage==1?"disabled":"")">
                <button class="page-link" @onclick="() => GoToPage(1)">«</button>
            </li>
            <li class="page-item @(CurrentPage==1?"disabled":"")">
                <button class="page-link" @onclick="() => GoToPage(CurrentPage-1)">Previous</button>
            </li>

            <li class="page-item px-2">
                <select class="form-select form-select-sm" style="width:100px; display:inline-block" @onchange="OnPageSelect" value="@CurrentPage">
                    @for (int p = 1; p <= TotalPages; p++)
                    {
                        <option value="@p" selected="@(p==CurrentPage)">Page @p</option>
                    }
                </select>
            </li>

            <li class="page-item @(CurrentPage==TotalPages?"disabled":"")">
                <button class="page-link" @onclick="() => GoToPage(CurrentPage+1)">Next</button>
            </li>
            <li class="page-item @(CurrentPage==TotalPages?"disabled":"")">
                <button class="page-link" @onclick="() => GoToPage(TotalPages)">»</button>
            </li>
        </ul>
    </nav>
</div>

@code {
    [Parameter] public IEnumerable<TItem>? Items { get; set; }
    [Parameter] public List<GridColumnDto> Columns { get; set; } = new List<GridColumnDto>();
    [Parameter] public int PageSize { get; set; } = 12;
    [Parameter] public string CardColumnClass { get; set; } = "col-12 col-sm-6 col-md-4 col-xl-3 mb-3";
    [Parameter] public RenderFragment<TItem> CardTemplate { get; set; } = default!;
    
    public int[] PageSizes { get; set; } = new[] { 8, 12, 16, 24 };

    List<TItem>? PagedItems;
    int CurrentPage = 1;
    int TotalPages = 1;
    int FilteredTotalCount = 0;

    // filtering state using shared service
    string[] TextOps = FilteringService<TItem>.TextOperations;

    // persistent per-column filters (field -> FilterState)
    Dictionary<string, FilteringService<TItem>.FilterState> ColumnFilters = new Dictionary<string, FilteringService<TItem>.FilterState>();

    // sorting
    GridColumnDto? SortColumn;
    bool SortAsc = true;

    protected override void OnParametersSet()
    {
        PageSize = PageSize;
        SetupPaging();
    }

    void SetupPaging()
    {
        CurrentPage = 1;
        var c = (Items?.Count() ?? 0);
        TotalPages = Math.Max(1, (int)Math.Ceiling((double)c / PageSize));
        ApplyPage();
    }

    void ApplyPage()
    {
        if (Items == null) { PagedItems = new List<TItem>(); return; }
        var list = ApplyFilterList(Items.ToList());
        FilteredTotalCount = list.Count;
        if (SortColumn != null) list = ApplySort(list, SortColumn, SortAsc);
        TotalPages = Math.Max(1, (int)Math.Ceiling((double)list.Count / PageSize));
        if (CurrentPage < 1) CurrentPage = 1;
        if (CurrentPage > TotalPages) CurrentPage = TotalPages;
        PagedItems = list.Skip((CurrentPage - 1) * PageSize).Take(PageSize).ToList();
    }

    List<TItem> ApplyFilterList(List<TItem> input)
    {
        return FilteringService<TItem>.ApplyFilters(input, ColumnFilters);
    }

    List<TItem> ApplySort(List<TItem> input, GridColumnDto col, bool asc)
    {
        return FilteringService<TItem>.ApplySort(input, col, asc);
    }

    object? GetValue(TItem? item, string field)
    {
        return FilteringService<TItem>.GetValue(item, field);
    }

    static bool MatchText(string value, string term, string op)
    {
        return FilteringService<TItem>.MatchText(value, term, op);
    }

    void OnTextFilterChanged(string field, ChangeEventArgs e)
    {
        var value = e.Value?.ToString() ?? string.Empty;
        FilteringService<TItem>.UpdateTextFilter(ColumnFilters, field, value);
        CurrentPage = 1;
        ApplyPage();
    }

    void OnTextFilterOpChanged(string field, ChangeEventArgs e)
    {
        var op = e.Value?.ToString() ?? "Contains";
        if (!ColumnFilters.ContainsKey(field))
        {
            FilteringService<TItem>.UpdateTextFilter(ColumnFilters, field, string.Empty, op);
        }
        else
        {
            ColumnFilters[field].TextOp = op;
        }
        CurrentPage = 1;
        ApplyPage();
    }

    void OnEnumFilterChanged(string field, ChangeEventArgs e)
    {
        var value = e.Value?.ToString() ?? string.Empty;
        FilteringService<TItem>.UpdateEnumFilter(ColumnFilters, field, value);
        CurrentPage = 1;
        ApplyPage();
    }

    void ClearColumnFilter(string field)
    {
        FilteringService<TItem>.ClearColumnFilter(ColumnFilters, field);
        ApplyPage();
    }

    void ClearAllFilters()
    {
        FilteringService<TItem>.ClearAllFilters(ColumnFilters);
        CurrentPage = 1;
        ApplyPage();
    }

    void OnSortColumnChanged(ChangeEventArgs e)
    {
        var field = e.Value?.ToString();
        if (string.IsNullOrEmpty(field))
        {
            SortColumn = null;
        }
        else
        {
            SortColumn = Columns.FirstOrDefault(c => c.Field == field);
        }
        SortAsc = true;
        ApplyPage();
    }

    void ToggleSortDirection()
    {
        SortAsc = !SortAsc;
        ApplyPage();
    }

    void OnPageSizeChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e?.Value?.ToString(), out var s)) { PageSize = s; SetupPaging(); }
    }

    void GoToPage(int p)
    {
        CurrentPage = Math.Clamp(p, 1, TotalPages);
        ApplyPage();
    }

    void OnPageSelect(ChangeEventArgs e)
    {
        if (int.TryParse(e?.Value?.ToString(), out var p))
        {
            GoToPage(p);
        }
    }

    bool IsFilterActive()
    {
        return FilteringService<TItem>.HasActiveFilters(ColumnFilters);
    }

    async Task ExportAll()
    {
        if (Items == null) return;
        var csv = BuildCsv(Items.ToList());
        var filename = $"cards_all_{DateTime.UtcNow:yyyyMMddHHmmss}.csv";
        await JS.InvokeVoidAsync("blazorDownload", filename, csv);
    }

    async Task ExportFiltered()
    {
        if (Items == null) return;
        var list = ApplyFilterList(Items.ToList());
        var csv = BuildCsv(list);
        var filename = $"cards_filtered_{DateTime.UtcNow:yyyyMMddHHmmss}.csv";
        await JS.InvokeVoidAsync("blazorDownload", filename, csv);
    }

    string BuildCsv(List<TItem> list)
    {
        var sb = new System.Text.StringBuilder();
        sb.AppendLine(string.Join(',', Columns.Select(c => c.Header)));
        foreach (var it in list)
        {
            var row = Columns.Select(c => EscapeCsv((GetValue(it, c.Field)?.ToString() ?? string.Empty))).ToArray();
            sb.AppendLine(string.Join(',', row));
        }
        return sb.ToString();
    }

    static string EscapeCsv(string input)
    {
        if (input == null) return string.Empty;
        if (input.Contains(',') || input.Contains('"') || input.Contains('\n')) return '"' + input.Replace("\"", "\"\"") + '"';
        return input;
    }
}
