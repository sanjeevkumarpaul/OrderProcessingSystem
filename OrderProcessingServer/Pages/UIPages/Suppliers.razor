@page "/suppliers"
@using OrderProcessingServer.Shared.Dto
@using OrderProcessingServer.Shared.UIComponents
@using OrderProcessingSystem.Utilities.Extensions
@using OrderProcessingSystem.Infrastructure.Models
@using OrderProcessingSystem.Infrastructure.Interfaces
@inherits BaseGridPage
@inject IJSRuntime JS
@inject OrderProcessingSystem.Infrastructure.Services.IGridColumnService GridColumnService
@inject IHttpClientFactory HttpFactory
<link rel="stylesheet" href="~/css/suppliers.css" />
<h1 class="page-title d-flex justify-content-between align-items-center">
  <span class="title-text">Suppliers</span>
  <div class="header-controls">
    <button class="btn btn-sm btn-primary" @onclick="ToggleGrid">@((showGrid) ? "Show Cards" : "All Suppliers")</button>
  </div>
</h1>

@if (suppliers == null)
{
  <p><em>Loading...</em></p>
}

@if (showGrid)
{
  <GenericGrid TItem="SupplierDto" Items="suppliers" Columns="supplierColumns" PageSize="10"  />
}
else
{
  <div class="row g-3">
    @foreach (var s in GetPagedCardSuppliers())
    {
      <div class="col-12 col-sm-6 col-md-4 col-xl-3 mb-3">
        <div class="card p-3" style="max-width:100%; word-break:break-word;">
          <h5 class="text-truncate">@s.Name</h5>
          <p class="small text-muted">Country: @s.Country</p>
          <p class="small">Orders Supplied: <strong>@s.OrdersSupplied</strong></p>
        </div>
      </div>
    }
  </div>

  <div class="d-flex justify-content-between mt-2 align-items-center">
    <div>
      <button class="btn btn-secondary me-2" @onclick="PrevSuppliers" disabled="@(supplierPageIndex==0)">Previous</button>
      <button class="btn btn-secondary" @onclick="NextSuppliers" disabled="@(supplierPageIndex+1>=supplierTotalPages)">Next</button>
    </div>
    <div>
      <small>Page @(supplierPageIndex+1) of @supplierTotalPages</small>
    </div>
  </div>
}

@code {
  List<SupplierDto>? suppliers = null;

  // Cards paging
  int supplierPageIndex = 0;
  int supplierPageSize = 12;
  int supplierTotalPages = 1;

  // Grid mode and paging
  bool showGrid = false;
  List<SupplierDto>? pagedGridSuppliers = null;
  
  // grid columns - keeping UI GridColumn for component compatibility
  List<OrderProcessingServer.Shared.UIComponents.GridColumn> supplierColumns = new List<OrderProcessingServer.Shared.UIComponents.GridColumn>();

  private bool _loaded;
  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
    if (!firstRender || _loaded) return;
    _loaded = true;

    try
    {
      var client = HttpFactory.CreateClient("ApiClient");
      suppliers = await client.GetFromJsonAsync<List<SupplierDto>>("api/data/suppliers") ?? new List<SupplierDto>();
      var orders = await client.GetFromJsonAsync<List<OrderDto>>("api/data/orders") ?? new List<OrderDto>();

      // compute OrdersSupplied per supplier
      var groups = orders
        .Where(o => o.SupplierId.HasValue)
        .GroupBy(o => o.SupplierId!.Value)
        .ToDictionary(g => g.Key, g => g.Count());
      foreach (var s in suppliers)
      {
        if (groups.TryGetValue(s.SupplierId, out var count))
        {
          s.OrdersSupplied = count;
        }
      }

      await LoadColumnMetadata();
      SetupCardsPaging();            
    }
    catch (Exception ex)
    {
      Console.WriteLine($"Error loading suppliers: {ex.Message}");
      await LoadColumnMetadata();
      suppliers = new List<SupplierDto>();
      SetupCardsPaging();          
    }
	finally
	{
	  await InvokeAsync(StateHasChanged);
	}
  }

  void NextSuppliers()
  {
    if (suppliers == null) return;
    if (supplierPageIndex + 1 >= supplierTotalPages) return;
    supplierPageIndex++;
  }

  void PrevSuppliers()
  {
    if (suppliers == null) return;
    if (supplierPageIndex <= 0) return;
    supplierPageIndex--;
  }

  void SetupCardsPaging()
  {
    supplierPageIndex = 0;
    var total = (suppliers ?? Enumerable.Empty<SupplierDto>()).Count();
    supplierTotalPages = Math.Max(1, (int)Math.Ceiling((double)total / supplierPageSize));
  }

  IEnumerable<SupplierDto> GetPagedCardSuppliers()
  {
    if (suppliers == null) return Enumerable.Empty<SupplierDto>();
    return suppliers.Skip(supplierPageIndex * supplierPageSize).Take(supplierPageSize);
  }

  void ToggleGrid()
  {
    showGrid = !showGrid;
    if (!showGrid) SetupCardsPaging();
  }

  async Task LoadColumnMetadata()
  {
    supplierColumns = await LoadUIColumnMetadataAsync("suppliers");
  }
}
