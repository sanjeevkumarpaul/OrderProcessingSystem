@page "/orders"
@using OrderProcessingSystem.Contracts.Dto
@using OrderProcessingSystem.UI.Shared.UIViewModels
@inject AutoMapper.IMapper Mapper
@inherits BaseDataPage<OrderVM>

<BaseDataPage TItem="OrderVM" 
              PageTitle="Orders"
              EntityName="orders"
              ShowCardsText="Show Cards"
              ShowGridText="Show Grid"
              GridPageSize="10"
              CardPageSize="12"
              CardColumnClass="col-12 col-sm-6 col-md-4 col-xl-3 mb-3"
              DataLoader="@LoadOrdersAsync"
              EnumMappings="@GetEnumMappings()">
    <CardTemplate Context="order">
        <div class="card p-3" style="max-width:100%; word-break:break-word;">
            <h5 class="text-truncate">Order #@order.OrderId</h5>
            <p class="small">Total: <strong>@order.Total.ToTwoDecimals(true)</strong></p>
            @if (order.Customer != null)
            {
                <p class="small">Customer: @order.Customer.Name</p>
            }
            @if (!string.IsNullOrEmpty(order.Status))
            {
                <span class="badge @GetStatusBadgeClass(order.Status)">@order.Status</span>
            }
        </div>
    </CardTemplate>
</BaseDataPage>

@code {
    // Data loader function for orders - now maps DTOs to ViewModels
    private async Task<List<OrderVM>?> LoadOrdersAsync()
    {
        var orderDtos = await ApiDataService.GetOrdersAsync();
        return orderDtos != null ? Mapper.Map<List<OrderVM>>(orderDtos) : null;
    }

    // Provide enum mappings for filtering
    private Dictionary<string, List<string>> GetEnumMappings()
    {
        return new Dictionary<string, List<string>>
        {
            ["Status"] = Enum.GetNames<OrderStatus>().ToList()
        };
    }

    // Helper method for status badge styling - updated to match enum values
    private string GetStatusBadgeClass(string status)
    {
        return status.ToLower() switch
        {
            "pending" => "badge-warning",
            "processing" => "badge-info", 
            "shipped" => "badge-primary",
            "delivered" => "badge-success",
            "completed" => "badge-success",
            "cancelled" => "badge-danger",
            _ => "badge-secondary"
        };
    }
}
